<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJ è¿ç»´æ¨¡æ‹Ÿå™¨ 2013</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --panel-bg: #16213e;
            --accent: #0f3460;
            --text: #e94560;
            --text-light: #f1f1f1;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --border: #333;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-light);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        #sidebar {
            width: 350px;
            background-color: var(--panel-bg);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        h2, h3 { margin: 0 0 8px 0; color: var(--text); font-size: 1.1em; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .stat-box {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .stat-val { font-weight: bold; color: #4fc3f7; font-family: monospace; font-size: 1.1em; }
        .sub-text { font-size: 0.8em; color: #888; }
        
        .forecast-row { display: flex; justify-content: space-between; font-size: 0.85em; color: #aaa; border-bottom: 1px dashed #333; padding: 2px 0; }
        .forecast-val { font-family: monospace; }
        .income { color: #69f0ae; }
        .expense { color: #ff5252; }

        button {
            background-color: var(--accent);
            color: white;
            border: 1px solid #444;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            margin: 4px 4px 4px 0;
            font-size: 0.9em;
        }
        button:hover { background-color: var(--text); transform: translateY(-1px); }
        button:disabled { background-color: #333; cursor: not-allowed; opacity: 0.6; transform: none; }
        
        .tabs { display: flex; border-bottom: 2px solid #333; margin-bottom: 15px; }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: rgba(0,0,0,0.2);
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
        }
        .tab.active { background: var(--text); color: white; font-weight: bold; }
        
        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .action-card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        #log-area {
            height: 200px;
            background: #111;
            font-family: 'Consolas', monospace;
            padding: 12px;
            overflow-y: auto;
            border: 1px solid #333;
            margin-top: auto;
            color: #ccc;
            font-size: 0.85em;
            border-radius: 6px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px;}
        .log-bad { color: #ff5252; }
        .log-good { color: #69f0ae; }
        .log-warn { color: #ffd740; }

        #warning-banner {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #ff8a80;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            display: none;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        #next-month-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: var(--success);
            border: none;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        #next-month-btn:hover { background-color: #43a047; }
        
        .progress-container { width: 100%; background-color: #333; height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--success); width: 0%; transition: width 0.5s ease-out; }
        
        /* ç½‘æ ¡å¡ç‰‡æ ·å¼ä¼˜åŒ– */
        .edu-card {
            background: #222; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            border-left: 4px solid var(--text);
        }
        .edu-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; }
        .edu-cost { font-size: 0.85em; color: #aaa; margin-bottom: 8px; line-height: 1.4; }
        .edu-actions { display: flex; gap: 8px; }
        .btn-run { background-color: #2e7d32; flex: 1; }
        .btn-up { background-color: #1565c0; flex: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="stat-box" style="background: var(--accent); text-align: center;">
        <h2 style="border:none; margin:0; color:#fff;">OJ è¿ç»´æ¨¡æ‹Ÿå™¨</h2>
        <div style="font-size:0.8em; opacity:0.7;">ç›®æ ‡: å­˜æ´»è‡³ 2026-01</div>
    </div>

    <div class="stat-box">
        <div class="stat-row"><span>ğŸ“… æ—¥æœŸ</span> <span id="disp-date" class="stat-val">2013-01</span></div>
        <div class="stat-row"><span>ğŸ’° èµ„é‡‘</span> <span id="disp-money" class="stat-val">2000</span></div>
        <div class="stat-row"><span>â­ å£°èª‰</span> <span id="disp-rep" class="stat-val">0.000</span></div>
        <div class="progress-container"><div id="rep-bar" class="progress-bar" style="width: 50%;"></div></div>
    </div>

    <!-- æ•…éšœç›‘æ§ -->
    <div class="stat-box" style="border: 1px solid #555;">
        <div class="stat-row"><span>âš ï¸ è¿ç»­æ•…éšœæœˆæ•°</span> <span id="disp-fail-months" style="color:#aaa; font-weight:bold">0 / 6</span></div>
        <div style="font-size:0.75em; color:#888;">è‹¥è¿ç»­6ä¸ªæœˆç¡¬ç›˜æ»¡æˆ–æœåŠ¡å™¨/è¯„æµ‹æœºè¿‡è½½ï¼Œæ¸¸æˆå¼ºåˆ¶ç»“æŸã€‚</div>
    </div>

    <!-- é¢„æµ‹æ¨¡å— -->
    <h3>ğŸ”® ä¸‹æœˆé¢„æµ‹</h3>
    <div class="stat-box">
        <div class="forecast-row"><span>é¢„è®¡æ”¶å…¥(ä½ä¿+API)</span> <span id="fc-income" class="forecast-val income">+0</span></div>
        <div class="forecast-row"><span>é¢„è®¡å·¥èµ„æ”¯å‡º</span> <span id="fc-salary" class="forecast-val expense">-0</span></div>
        <div class="forecast-row"><span>é¢„è®¡ç»´æŠ¤æ”¯å‡º</span> <span id="fc-maint" class="forecast-val expense">-0</span></div>
        <div class="stat-row" style="margin-top:5px; border-top:1px solid #444; padding-top:5px;">
            <span>é¢„è®¡å‡€æ”¶æ”¯:</span> <span id="fc-net" class="stat-val">0</span>
        </div>
        <div style="font-size:0.8em; color:#888; margin-top:5px;">
            ç ”å‘ç»´æŠ¤: <span id="fc-rd-cost">0</span>/æœˆ<br>
            å­¦æœ¯éœ€æ±‚: <span id="fc-acad-cost">0</span>/æœˆ<br>
            ç¤¾åŒºéœ€æ±‚: <span id="fc-comm-cost">0</span>/æœˆ
        </div>
    </div>

    <h3>âš¡ èµ„æºæ± </h3>
    <div class="stat-box">
        <div class="stat-row"><span>è¡ŒåŠ¨åŠ› (AP)</span> <span id="disp-ap" class="stat-val" style="color: #ffca28;">100</span></div>
        <div class="stat-row"><span>ç ”å‘ç‚¹</span> <span id="disp-rd" class="stat-val">0</span></div>
        <div class="stat-row"><span>å­¦æœ¯ç‚¹</span> <span id="disp-acad" class="stat-val">0</span></div>
        <div class="stat-row"><span>ç¤¾åŒºç‚¹</span> <span id="disp-comm" class="stat-val">0</span></div>
    </div>

    <h3>ğŸ“Š è¿è¥æ•°æ®</h3>
    <div class="stat-box">
        <div class="stat-row"><span>æ€»ç”¨æˆ·</span> <span id="disp-users-total" class="stat-val">50</span></div>
        <div class="stat-row"><span class="sub-text">ä¸Šæœˆæ–°å¢æäº¤</span> <span id="disp-last-subs" style="color:#fff">0</span></div>
        <div class="stat-row"><span class="sub-text">ä¸Šæœˆæ–°å¢é¢˜è§£</span> <span id="disp-last-sols" style="color:#fff">0</span></div>
        <hr style="border-color:#444; margin: 8px 0;">
        <div class="stat-row"><span>é¢˜åº“ (é«˜/ä¸­/ä½)</span> <span><span id="disp-prob-high">0</span>/<span id="disp-prob-mid">0</span>/<span id="disp-prob-low">0</span></span></div>
        <div class="stat-row"><span class="sub-text">ç¡¬ç›˜å ç”¨</span> <span id="disp-disk">0 GB</span></div>
    </div>

    <h3>ğŸ–¥ï¸ æœåŠ¡å™¨</h3>
    <div class="stat-box">
        <div class="stat-row"><span>Webæ ¸å¿ƒ</span> <span><span id="disp-server-core" class="stat-val">2</span> æ ¸ (Lv.<span id="disp-server-arch">1</span>)</span></div>
        <div class="stat-row"><span>è¯„æµ‹æ ¸å¿ƒ</span> <span><span id="disp-judge-core" class="stat-val">1</span> æ ¸ (Lv.<span id="disp-judge-arch">1</span>)</span></div>
        <div class="stat-row" style="justify-content: flex-end; font-size: 0.8em; color: #888;">Webè´Ÿè½½: <span id="disp-server-load">0</span> / <span id="disp-server-cap">0</span></div>
    </div>
</div>

<div id="main">
    <div id="warning-banner">âš ï¸ è­¦å‘Šï¼šé¢„è®¡ä¸‹ä¸ªæœˆå°†ç ´äº§ï¼è¯·ç«‹å³ç­¹é›†èµ„é‡‘ï¼</div>
    
    <button id="next-month-btn" onclick="game.nextMonth()">è¿›å…¥ä¸‹ä¸ªæœˆ</button>

    <div class="tabs">
        <div class="tab active" onclick="ui.switchTab('ops')">æ—¥å¸¸è¿è¥</div>
        <div class="tab" onclick="ui.switchTab('rd')">ç ”å‘ä¸­å¿ƒ</div>
        <div class="tab" onclick="ui.switchTab('hr')">äººæ‰æ‹›å‹Ÿ</div>
        <div class="tab" onclick="ui.switchTab('edu')">ç½‘æ ¡è¯¾ç¨‹</div>
    </div>

    <!-- Operations Tab -->
    <div id="tab-ops" class="panel active">
        <div class="action-card">
            <h3>ğŸ“¢ èµ„æºè½¬åŒ– (æ¯æ¬¡ 10 è¡ŒåŠ¨åŠ›)</h3>
            <button onclick="game.convertAP('rd')">è½¬ç ”å‘ (+10)</button>
            <button onclick="game.convertAP('acad')">è½¬å­¦æœ¯ (+10)</button>
            <button onclick="game.convertAP('comm')">è½¬ç¤¾åŒº (+10)</button>
            <button onclick="game.fundraising()" style="float:right; background:#5d4037">å·å¬å‹Ÿæ (50 è¡ŒåŠ¨åŠ›, é™å£°èª‰)</button>
            <div style="clear:both; margin-top:5px; font-size:0.8em; color:#aaa;">
                å‹Ÿæè·å¾—é‡‘é’±æ•°: ç”¨æˆ·æ•° Ã— (å£°èª‰+1) Ã— 5
            </div>
        </div>

        <div class="action-card">
            <h3>ğŸ† èµ›äº‹è¿è¥</h3>
            <div class="card-desc">ä¸¾åŠæ¯”èµ›å¯æå‡ä¸‹æœˆç”¨æˆ·å¢é•¿é€Ÿåº¦ã€‚</div>
            <button onclick="game.organizeContest('old')">åŸé¢˜èµ› (éœ€è¦$500, å­¦æœ¯40)<br><span style="font-size:0.8em">æ™®é€šé¢˜ç›®+4, å¢é•¿x1.05</span></button>
            <button onclick="game.organizeContest('water')">æ°´èµ› (éœ€è¦$1000, å­¦æœ¯40)<br><span style="font-size:0.8em">ä½è´¨é¢˜ç›®+6, å¢é•¿x1.15</span></button>
            <button onclick="game.organizeContest('normal')">æ™®é€šèµ› (éœ€è¦$3000, å­¦æœ¯80)<br><span style="font-size:0.8em">æ™®é€šé¢˜ç›®+4, å¢é•¿x1.1</span></button>
            <button onclick="game.organizeContest('grand')">ä¼˜ç§€èµ› (éœ€è¦$8000, å­¦æœ¯200)<br><span style="font-size:0.8em">é«˜è´¨é¢˜ç›®+3, å¢é•¿x1.1, å‡å£°èª‰</span></button>
        </div>
        
        <div class="action-card">
            <h3>ğŸ“ é¢˜åº“æ‰©å……</h3>
            <button onclick="game.addProblem('high')">é«˜è´¨é‡ (+3é¢˜, -20å­¦æœ¯)</button>
            <button onclick="game.addProblem('mid')">æ™®é€š (+10é¢˜, -20å­¦æœ¯)</button>
            <button onclick="game.addProblem('low')">ä½è´¨é‡ (+20é¢˜, -20å­¦æœ¯)</button>
        </div>
    </div>

    <!-- R&D Tab -->
    <div id="tab-rd" class="panel">
        <div class="action-card">
            <h3>ğŸ’» åŸºç¡€è®¾æ–½</h3>
            <button onclick="game.expandHardware('server')">åŠ  Web æ ¸å¿ƒ (+1)</button>
            <button onclick="game.expandHardware('judge')">åŠ  è¯„æµ‹ æ ¸å¿ƒ (+1)</button>
            <button onclick="game.expandHardware('disk')">åŠ  ç¡¬ç›˜ (+40GB)</button>
        </div>
        <div class="action-card">
            <h3>ğŸš€ åŠŸèƒ½ç ”å‘</h3>
            <div id="rd-list"></div>
        </div>
        <div class="action-card">
            <h3>ğŸ—ï¸ æ¶æ„å‡çº§</h3>
            <div class="card-desc">æ¶æ„å‡çº§åï¼Œæ¯ä¸ªæ ¸å¿ƒå¯é¢å¤–å®¹çº³ 100 æ´»è·ƒç”¨æˆ·ã€‚</div>
            <button onclick="game.upgradeArch('server')">Webæ¶æ„å‡çº§</button>
            <button onclick="game.upgradeArch('judge')">è¯„æµ‹æ¶æ„å‡çº§</button>
        </div>
    </div>

    <!-- HR Tab -->
    <div id="tab-hr" class="panel">
        <div class="action-card">
            <h3>æ‹›è˜å¸‚åœº (æ¶ˆè€— 10 APï¼Œå…¼èŒäººæ•°æœ‰ä¸Šé™ï¼)</h3>
            <h4 style="margin-top:0">ç ”å‘å›¢é˜Ÿ (äº§å‡º: <span id="out-rd">0</span>/æœˆ)</h4>
            <button onclick="game.hire('rd_student')">é«˜ä¸­ç”Ÿ ($1500, +20 ç ”å‘)</button>
            <button onclick="game.hire('rd_uni')">å¤§å­¦ç”Ÿ ($5000, +75 ç ”å‘)</button>
            <button onclick="game.hire('rd_full')">å…¨èŒå¤§ç‰› ($12000, +120 ç ”å‘)</button>
            
            <h4 style="margin-top:10px">å­¦æœ¯å›¢é˜Ÿ (äº§å‡º: <span id="out-acad">0</span>/æœˆ)</h4>
            <button onclick="game.hire('acad_part')">ç°å½¹é€‰æ‰‹ ($500, +50 å­¦æœ¯)</button>
            <button onclick="game.hire('acad_full')">å…¨èŒæ•™ç»ƒ ($15000, +400 å­¦æœ¯)</button>
            
            <h4 style="margin-top:10px">ç¤¾åŒºå›¢é˜Ÿ (äº§å‡º: <span id="out-comm">0</span>/æœˆ)</h4>
            <button onclick="game.hire('comm_part')">å…¼èŒç‰ˆä¸» ($500, +50 ç¤¾åŒº)</button>
            <button onclick="game.hire('comm_full')">å…¨èŒè¿è¥ ($7500, +400 ç¤¾åŒº)</button>
        </div>
    </div>

    <!-- Edu Tab -->
    <div id="tab-edu" class="panel">
        <div class="action-card">
            <h3>ğŸ« ç½‘æ ¡ç®¡ç†</h3>
            <p style="font-size:0.85em; color:#aaa">ç ”å‘[ç½‘æ ¡åŠŸèƒ½]åè§£é”ã€‚è¯¾ç¨‹å‡çº§åå¸¦æ¥æ›´å¤šæ”¶å…¥ï¼Œä½†å‡çº§æˆæœ¬ä¹Ÿä¼šå¢åŠ ã€‚å¼€è¯¾åæœ‰ 3 ä¸ªæœˆå†·å´æœŸã€‚</p>
            <div id="edu-list"></div>
        </div>
    </div>

    <div id="log-area">
        <div class="log-entry" style="color:#4fc3f7">ğŸ’¡ æ¬¢è¿æ¥åˆ° OJ è¿ç»´æ¨¡æ‹Ÿå™¨ï¼</div>
        <div class="log-entry">è¯·å¯†åˆ‡å…³æ³¨å·¦ä¾§çš„ã€ä¸‹æœˆé¢„æµ‹ã€‘é¢æ¿ï¼Œé¿å…ç ´äº§ã€‚</div>
    </div>
</div>

<script>
const GAME_PARAMS = {
    INITIAL: { YEAR: 2013, MONTH: 1, MONEY: 2000, AP: 100, USERS: 50, SERVER_CORES: 2, JUDGE_CORES: 1, DISK_MB: 20480 },
    INCOME: { MONTHLY_GRANT: 500 },
    COSTS: {
        SERVER_CORE_RENT: 200, JUDGE_CORE_RENT: 200, DISK_BLOCK_RENT: 100, DISK_BLOCK_SIZE_GB: 40,
        ADD_PROBLEM_ACAD: 20, HIRE_AP: 10
    },
    HIRING: {
        rd_student: { name: "é«˜ä¸­å…¼èŒ", cost: 1500, gain: 20, limit: 5, type: 'rd' },
        rd_uni:     { name: "å¤§å­¦å…¼èŒ", cost: 5000, gain: 75, limit: 5, type: 'rd' },
        rd_full:    { name: "å…¨èŒå¼€å‘", cost: 12000, gain: 120, limit: 999, type: 'rd' },
        acad_part:  { name: "ç°å½¹é€‰æ‰‹", cost: 500, gain: 50, limit: 20, type: 'acad' },
        acad_full:  { name: "å…¨èŒæ•™ç»ƒ", cost: 15000, gain: 400, limit: 999, type: 'acad' },
        comm_part:  { name: "å…¼èŒç‰ˆä¸»", cost: 500, gain: 50, limit: 5, type: 'comm' },
        comm_full:  { name: "å…¨èŒè¿è¥", cost: 7500, gain: 400, limit: 999, type: 'comm' }
    },
    CONTESTS: {
        old:    { name: "åŸé¢˜èµ›", cost: 500, acad: 40, prob_mid: 4, rep_pen: 0.1, growth_mult: 1.05 },
        water:  { name: "æ°´èµ›", cost: 1000, acad: 40, prob_low: 6, rep_pen: 0.1, growth_mult: 1.15 },
        normal: { name: "æ™®é€šèµ›", cost: 3000, acad: 80, prob_mid: 4, growth_mult: 1.1 },
        grand:  { name: "ä¼˜ç§€èµ›", cost: 8000, acad: 200, prob_high: 3, rep_gain: 0.01, growth_mult: 1.1 }
    },
    FEATURES: {
        difficulty: { id: 'difficulty', name: "éš¾åº¦åŠŸèƒ½", cost: 1000, rd: 100, maintain: 0, desc: "è®© OJ æ”¯æŒéš¾åº¦è¯„çº§ï¼Œéœ€è¦å°‘é‡å­¦æœ¯ç»´æŠ¤ï¼Œå¯ä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·ä½¿ç”¨ä½ çš„ OJ" },
        solution:   { id: 'solution', name: "é¢˜è§£åŠŸèƒ½", cost: 1000, rd: 100, maintain: 10, desc: "è®© OJ å¯ä»¥æ˜¾ç¤ºé¢˜è§£ï¼Œéœ€è¦å­¦æœ¯ç»´æŠ¤ï¼Œå¯ä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·ä½¿ç”¨ä½ çš„ OJ" },
        discuss:    { id: 'discuss', name: "è®¨è®ºåŒº", cost: 5000, rd: 300, maintain: 20, desc: "è®© OJ æœ‰è®¨è®ºåŒºï¼Œéœ€è¦ç¤¾åŒºç»´æŠ¤ï¼Œå¯ä»¥å¸å¼•æ›´å¤šçš„ç”¨æˆ·ä½¿ç”¨ä½ çš„ OJ" },
        team:       { id: 'team', name: "å›¢é˜ŸåŠŸèƒ½", cost: 10000, rd: 500, maintain: 30, desc: "è®© OJ æ‹¥æœ‰å›¢é˜ŸåŠŸèƒ½ï¼Œå¯ä»¥å¸å¼•å­¦æ ¡/æœºæ„ä½¿ç”¨ OJï¼Œä½†æ˜¯å›¢é˜ŸåŠŸèƒ½ä¼šé™ä½æœåŠ¡å™¨æ‰¿è½½åŠ›" },
        school:     { id: 'school', name: "ç½‘æ ¡åŠŸèƒ½", cost: 20000, rd: 800, maintain: 40, desc: "è§£é”ç½‘æ ¡è¯¾ç¨‹" },
        api:        { id: 'api', name: "è¯„æµ‹API", cost: 30000, rd: 1500, maintain: 50, desc: "å‡ºå”®å¤–éƒ¨è¯„æµ‹æœåŠ¡ï¼Œè·å¾—å¤§é‡ç¨³å®šç°é‡‘æµï¼Œä½†æ˜¯ä¼šé™ä½æœåŠ¡å™¨æ‰¿è½½åŠ›" }
    },
    USER_BEHAVIOR: {
        SUBMISSIONS: { normal: 15, active: 65, core: 300 },
        SOLUTIONS: { normal: 0.01, active: 1, core: 5 },
        GROWTH_FACTOR: 0.25, 
        UPGRADE_N_A_BASE: 4, UPGRADE_N_A_MULT: 10, UPGRADE_A_C_MULT: 5
    },
    DISK_USAGE: { PROBLEM: 50, USER_DATA: 0.05, SUBMISSION: 0.002, SOLUTION: 0.005 },
    CLASSES: {
        intro: { name: "å…¥é—¨è¯¾", max: 3, cost_base: 3000, acad_base: 100, inc_base: 10000, req_money: 4000, req_acad: 100 },
        basic: { name: "åŸºç¡€è¯¾", max: 3, cost_base: 5000, acad_base: 150, inc_base: 15000, req_money: 6000, req_acad: 150 },
        advanced: { name: "æé«˜è¯¾", max: 5, cost_base: 10000, acad_base: 200, inc_base: 25000, req_money: 10000, req_acad: 240 },
        sprint: { name: "å†²åˆºç­", max: 3, cost_base: 20000, acad_base: 200, inc_base: 40000, req_money: 20000, req_acad: 200, season: [7,8,9,10] },
        national: { name: "å›½èµ›ç­", max: 5, cost_base: 25000, acad_base: 300, inc_base: 50000, req_money: 40000, req_acad: 400 }
    }
};

const game = {
    date: { year: GAME_PARAMS.INITIAL.YEAR, month: GAME_PARAMS.INITIAL.MONTH },
    money: GAME_PARAMS.INITIAL.MONEY,
    ap: GAME_PARAMS.INITIAL.AP,
    resources: { rd: 0, acad: 0, comm: 0 },
    stats: {
        users: { normal: GAME_PARAMS.INITIAL.USERS, active: 0, core: 0 },
        problems: { high: 0, mid: 0, low: 0 },
        total_submissions: 0,
        total_solutions: 0,
        reputation: 0,
        last_month: { subs: 0, sols: 0 },
        consecutive_failure_months: 0
    },
    hardware: {
        server_cores: GAME_PARAMS.INITIAL.SERVER_CORES, judge_cores: GAME_PARAMS.INITIAL.JUDGE_CORES,
        disk_extra_blocks: 0, disk_used: 0, server_arch: 1, judge_arch: 1
    },
    staff: {}, class_state: {}, features_unlocked: {},
    flags: {
        fundraising_penalty_val: 0,
        temp_rep_penalty: 0,
        contest_growth_mult: 1.0
    },

    init: function() {
        for(let k in GAME_PARAMS.HIRING) this.staff[k] = 0;
        for(let k in GAME_PARAMS.CLASSES) this.class_state[k] = { level: 1, cooldown: 0 };
        for(let k in GAME_PARAMS.FEATURES) this.features_unlocked[k] = false;
        ui.update(); ui.renderRD(); ui.renderClasses();
    },

    nextMonth: function() {
        this.date.month++;
        if (this.date.month > 12) { this.date.month = 1; this.date.year++; }
        const isFreeEra = (this.date.year === 2013 && this.date.month < 7);
        ui.log(`=== ${this.date.year}å¹´ ${this.date.month}æœˆ ===`, 'log-warn');
        if (this.date.year >= 2026) { this.endGame(); return; }

        this.ap = 100;
        let salary = 0;
        let gain = { rd: 0, acad: 0, comm: 0 };
        for (let k in this.staff) {
            let count = this.staff[k], conf = GAME_PARAMS.HIRING[k];
            if (count > 0) { salary += count * conf.cost; gain[conf.type] += count * conf.gain; }
        }
        
        this.money += GAME_PARAMS.INCOME.MONTHLY_GRANT;
        this.money -= salary;
        this.resources.rd += gain.rd; this.resources.acad += gain.acad; this.resources.comm += gain.comm;
        
        if(salary > 0) ui.log(`è´¢åŠ¡: å‘æ”¾å·¥èµ„ ${salary}, äº§å‡º R:${gain.rd} A:${gain.acad} C:${gain.comm}`);

        // Maintenance
        let maintain_rd = 0;
        for (let k in GAME_PARAMS.FEATURES) if (this.features_unlocked[k]) maintain_rd += GAME_PARAMS.FEATURES[k].maintain;
        maintain_rd += 20 * (this.hardware.server_arch - 1);
        maintain_rd += 20 * (this.hardware.judge_arch - 1);
        this.resources.rd -= maintain_rd;
        
        // Hardware Costs
        let hw_cost = this.hardware.disk_extra_blocks * GAME_PARAMS.COSTS.DISK_BLOCK_RENT;
        if (!isFreeEra) {
            hw_cost += this.hardware.server_cores * GAME_PARAMS.COSTS.SERVER_CORE_RENT;
            hw_cost += this.hardware.judge_cores * GAME_PARAMS.COSTS.JUDGE_CORE_RENT;
        }
        this.money -= hw_cost;
        if(hw_cost > 0) ui.log(`è´¢åŠ¡: ç¡¬ä»¶ç§Ÿé‡‘ ${hw_cost}`);

        // --- Load & API (Adjusted Logic) ---
        // Arch Update: +100 cap per core per level above 1
        let server_arch_bonus = (this.hardware.server_arch - 1) * 100;
        let judge_arch_bonus = (this.hardware.judge_arch - 1) * 100;

        let server_cap_unit = 500 - (this.features_unlocked.team?50:0) - (this.features_unlocked.api?50:0) + server_arch_bonus;
        let judge_cap_unit = 500 + judge_arch_bonus;

        let server_cap = this.hardware.server_cores * server_cap_unit;
        let judge_cap = this.hardware.judge_cores * judge_cap_unit;

        let u = this.stats.users;
        let load = u.active + (u.normal / 3) + (u.core * 3);
        if ([7,8,9,10].includes(this.date.month)) load *= 1.3;
        
        // API Income: now 1 * total_users
        if (this.features_unlocked.api) {
            let total_u = u.normal + u.active + u.core;
            this.money += Math.floor(total_u * 1.0); // Changed from 0.01 to 1.0
        }

        // --- Growth Logic ---
        let rep = this.stats.reputation;
        let total_users = u.normal + u.active + u.core;
        
        let pct_rate = (rep * 8 + 4) / 100;
        if (pct_rate < 0) pct_rate = 0;
        let growth_from_pct = total_users * pct_rate;
        let growth_from_fixed = (rep + 1) * 50;
        if (growth_from_fixed < 0) growth_from_fixed = 0;

        let new_users = Math.floor(growth_from_pct + growth_from_fixed);
        if (this.flags.contest_growth_mult !== 1.0) {
            new_users = Math.floor(new_users * this.flags.contest_growth_mult);
            this.flags.contest_growth_mult = 1.0; 
        }
        
        u.normal += new_users;
        if (new_users > 0) ui.log(`ç”¨æˆ·: æ–°å¢ ${new_users} äºº`);

        // Flow
        let prob_n2a = (rep * GAME_PARAMS.USER_BEHAVIOR.UPGRADE_N_A_MULT + GAME_PARAMS.USER_BEHAVIOR.UPGRADE_N_A_BASE) / 100;
        if (this.features_unlocked.difficulty) prob_n2a *= 1.1;
        if (this.features_unlocked.solution) prob_n2a *= 1.25;
        if (this.features_unlocked.discuss) prob_n2a *= 1.1;
        if (this.features_unlocked.team) prob_n2a *= 1.1;
        
        let delta_n2a = Math.floor(u.normal * prob_n2a);
        if (delta_n2a > 0) { u.normal -= delta_n2a; u.active += delta_n2a; } 
        else { let delta_a2n = Math.floor(u.active * Math.abs(prob_n2a)); u.active -= delta_a2n; u.normal += delta_a2n; }

        let prob_a2c = (rep * GAME_PARAMS.USER_BEHAVIOR.UPGRADE_A_C_MULT) / 100;
        let delta_a2c = Math.floor(u.active * prob_a2c);
        if (delta_a2c > 0) { u.active -= delta_a2c; u.core += delta_a2c; }

        // Churn
        u.normal -= Math.ceil(u.normal / 120); u.active -= Math.ceil(u.active / 60);
        let core_churn = Math.ceil(u.core / 36); u.core -= core_churn; u.active += core_churn;

        // Data & Disk
        let subs = (u.normal * GAME_PARAMS.USER_BEHAVIOR.SUBMISSIONS.normal) +
                   (u.active * GAME_PARAMS.USER_BEHAVIOR.SUBMISSIONS.active) +
                   (u.core * GAME_PARAMS.USER_BEHAVIOR.SUBMISSIONS.core);
        let subs_int = Math.floor(subs);
        this.stats.total_submissions += subs_int;
        this.stats.last_month.subs = subs_int; 
        
        let sols = 0;
        if (this.features_unlocked.solution) {
            sols = (u.normal * GAME_PARAMS.USER_BEHAVIOR.SOLUTIONS.normal) +
                   (u.active * GAME_PARAMS.USER_BEHAVIOR.SOLUTIONS.active) +
                   (u.core * GAME_PARAMS.USER_BEHAVIOR.SOLUTIONS.core);
        }
        let sols_int = Math.floor(sols);
        this.stats.total_solutions += sols_int;
        this.stats.last_month.sols = sols_int;

        let p = this.stats.problems;
        let total_prob = p.high + p.mid + p.low;
        let disk = (total_prob * GAME_PARAMS.DISK_USAGE.PROBLEM) +
                   (total_users * GAME_PARAMS.DISK_USAGE.USER_DATA) +
                   (this.stats.total_submissions * GAME_PARAMS.DISK_USAGE.SUBMISSION) +
                   (this.stats.total_solutions * GAME_PARAMS.DISK_USAGE.SOLUTION);
        this.hardware.disk_used = disk;
        
        let disk_cap = GAME_PARAMS.INITIAL.DISK_MB + (this.hardware.disk_extra_blocks * GAME_PARAMS.COSTS.DISK_BLOCK_SIZE_GB * 1024);
        
        // System Failure Check
        let is_disk_full = disk > disk_cap;
        let is_server_overload = load > server_cap;
        let is_judge_overload = load > judge_cap;
        
        if (is_disk_full) ui.log("âŒ ç¡¬ç›˜å·²æ»¡ï¼æ•°æ®å†™å…¥å¤±è´¥ï¼", "log-bad");
        if (is_server_overload) ui.log("âŒ WebæœåŠ¡å™¨è¿‡è½½ï¼", "log-bad");
        if (is_judge_overload) ui.log("âŒ è¯„æµ‹æœºè¿‡è½½ï¼", "log-bad");
        
        if (is_disk_full || is_server_overload || is_judge_overload) {
            this.stats.consecutive_failure_months++;
            ui.log(`âš ï¸ ç³»ç»Ÿæ•…éšœï¼è¿ç»­æ•…éšœæœˆæ•°: ${this.stats.consecutive_failure_months}/6`, "log-bad");
            if (this.stats.consecutive_failure_months >= 6) {
                alert("ç”±äºé•¿æœŸç»´æŠ¤ä¸å–„ï¼ˆè¿ç»­6ä¸ªæœˆæ•…éšœï¼‰ï¼Œæ‚¨çš„ OJ è¢«è§†ä½œå…³åœã€‚æ¸¸æˆç»“æŸã€‚");
                document.getElementById('next-month-btn').disabled = true;
                return;
            }
        } else {
            if (this.stats.consecutive_failure_months > 0) {
                ui.log("âœ… ç³»ç»ŸçŠ¶æ€å·²æ¢å¤æ­£å¸¸ï¼Œæ•…éšœè®¡æ•°é‡ç½®ã€‚", "log-good");
            }
            this.stats.consecutive_failure_months = 0;
        }

        // Needs & Rep
        let acad_need = 0;
        if (this.features_unlocked.difficulty) acad_need += total_prob * 0.05;
        if (this.features_unlocked.solution) acad_need += total_prob * 0.1;
        let comm_need = 0;
        if (this.features_unlocked.discuss) comm_need += total_users * 0.01;
        
        this.resources.acad -= acad_need;
        this.resources.comm -= comm_need;
        
        let acad_gap = (this.resources.acad < 0) ? Math.abs(this.resources.acad) : 0;
        let comm_gap = (this.resources.comm < 0) ? Math.abs(this.resources.comm) : 0;
        let server_gap = Math.max(0, load - server_cap);
        let judge_gap = Math.max(0, load - judge_cap);
        
        this.calculateReputation(acad_gap, comm_gap, server_gap, judge_gap, total_prob);

        // Cooldowns
        for(let k in this.class_state) if (this.class_state[k].cooldown > 0) this.class_state[k].cooldown--;
        
        if (this.flags.fundraising_penalty_val > 0) {
            this.flags.fundraising_penalty_val -= (0.2 / 12);
            if (this.flags.fundraising_penalty_val < 0) this.flags.fundraising_penalty_val = 0;
        }
        if (this.flags.temp_rep_penalty > 0) this.flags.temp_rep_penalty = Math.max(0, this.flags.temp_rep_penalty - (0.1/3));

        if (this.money < 0) { alert("èµ„é‡‘é“¾æ–­è£‚ï¼æ‚¨ç ´äº§äº†ï¼"); document.getElementById('next-month-btn').disabled = true; }

        ui.update();
    },

    calculateReputation: function(acad_gap, comm_gap, server_gap, judge_gap, total_prob) {
        let p = this.stats.problems, u = this.stats.users;
        let r_acad = 0;
        if (p.high > 0) r_acad += Math.log10(p.high) / 10;
        if (total_prob > 0 && (p.high / total_prob) > 0.4) r_acad += (p.high/total_prob) - 0.4;
        if (p.low > 0) r_acad -= Math.log10(p.low) / 10;
        r_acad = Math.min(0.4, r_acad);

        let r_users = (Math.log(Math.max(1, u.normal))/Math.log(200) + Math.log(Math.max(1, u.active))/Math.log(100) + Math.log(Math.max(1, u.core))/Math.log(50)) / 40;
        r_users = Math.min(0.3, r_users);

        let r_edu = 0;
        r_edu += this.class_state.intro.level * 0.01;
        r_edu += this.class_state.basic.level * 0.01;
        r_edu += this.class_state.advanced.level * 0.02;
        r_edu += this.class_state.sprint.level * 0.02;
        r_edu += this.class_state.national.level * 0.02;
        r_edu = Math.min(0.3, r_edu);

        let r_stable = 0;
        if (acad_gap > 0) r_stable -= Math.log10(acad_gap) / 20;
        if (comm_gap > 0) r_stable -= Math.log10(comm_gap) / 20;
        if (server_gap > 0) r_stable -= Math.log10(server_gap) / 10;
        if (judge_gap > 0) r_stable -= Math.log10(judge_gap) / 10;
        
        r_stable -= this.flags.fundraising_penalty_val;
        r_stable -= this.flags.temp_rep_penalty;
        
        let total = r_acad + r_users + r_edu + r_stable;
        if (total > 1) total = 1;
        this.stats.reputation = total;
    },

    convertAP: function(target) {
        if (this.ap < 10) { ui.log("APä¸è¶³", "log-bad"); return; }
        this.ap -= 10; this.resources[target] += 10;
        ui.log(`è¡ŒåŠ¨: 10 AP -> 10 ${target}ç‚¹`); ui.update();
    },

    addProblem: function(type) {
        if (this.resources.acad < GAME_PARAMS.COSTS.ADD_PROBLEM_ACAD) { ui.log("å­¦æœ¯ä¸è¶³", "log-bad"); return; }
        this.resources.acad -= GAME_PARAMS.COSTS.ADD_PROBLEM_ACAD;
        if (type === 'high') this.stats.problems.high += 3;
        if (type === 'mid') this.stats.problems.mid += 10;
        if (type === 'low') { this.stats.problems.low += 20; this.stats.reputation -= 0.001; }
        ui.log(`é¢˜åº“: å¢åŠ  ${type} è¯•é¢˜`); ui.update();
    },

    organizeContest: function(key) {
        let conf = GAME_PARAMS.CONTESTS[key];
        if (this.money < conf.cost || this.resources.acad < conf.acad) { ui.log("èµ„æºä¸è¶³", "log-bad"); return; }
        this.money -= conf.cost; this.resources.acad -= conf.acad;
        
        if (conf.prob_mid) this.stats.problems.mid += conf.prob_mid;
        if (conf.prob_low) this.stats.problems.low += conf.prob_low;
        if (conf.prob_high) this.stats.problems.high += conf.prob_high;
        
        if (conf.rep_pen) this.flags.temp_rep_penalty += conf.rep_pen;
        if (conf.rep_gain) this.stats.reputation += conf.rep_gain;
        if (conf.growth_mult) this.flags.contest_growth_mult = conf.growth_mult;
        
        ui.log(`æ¯”èµ›: ${conf.name} (ä¸‹æœˆå¢é•¿ x${conf.growth_mult})`); ui.update();
    },

    fundraising: function() {
        if (this.ap < 50) return;
        this.ap -= 50;
        let u = this.stats.users;
        let total_users = u.normal + u.active + u.core;
        let gain = Math.floor(total_users * (this.stats.reputation + 1) * 5);
        if (gain < 0) gain = 0;
        
        this.money += gain;
        this.flags.fundraising_penalty_val += 0.2;
        ui.log(`å‹Ÿæ: è·å¾— ${gain} å…ƒï¼Œå£°èª‰å—æŸ`, "log-bad"); ui.update();
    },

    hire: function(key) {
        if (this.ap < GAME_PARAMS.COSTS.HIRE_AP) return;
        let conf = GAME_PARAMS.HIRING[key];
        if (this.staff[key] >= conf.limit) { ui.log("äººæ•°å·²æ»¡", "log-bad"); return; }
        this.staff[key]++; this.ap -= GAME_PARAMS.COSTS.HIRE_AP;
        ui.log(`æ‹›è˜: ${conf.name}`); ui.update();
    },

    expandHardware: function(type) {
        if (type === 'disk') { this.hardware.disk_extra_blocks++; ui.log("ç¡¬ä»¶: ç¡¬ç›˜æ‰©å®¹"); ui.update(); return; }
        let arch = (type === 'server') ? this.hardware.server_arch : this.hardware.judge_arch;
        let current = (type === 'server') ? this.hardware.server_cores : this.hardware.judge_cores;
        if (current >= (type==='server'?32:64) * arch) { ui.log("éœ€å‡çº§æ¶æ„", "log-bad"); return; }
        if (type === 'server') this.hardware.server_cores++; else this.hardware.judge_cores++;
        ui.log(`ç¡¬ä»¶: ${type} +1`); ui.update();
    },

    upgradeArch: function(type) {
        let level = (type === 'server') ? this.hardware.server_arch : this.hardware.judge_arch;
        let cost_m = 10000 * level, cost_r = 100 * level;
        if (this.money < cost_m || this.resources.rd < cost_r) { ui.log("èµ„æºä¸è¶³", "log-bad"); return; }
        this.money -= cost_m; this.resources.rd -= cost_r;
        if (type === 'server') this.hardware.server_arch++; else this.hardware.judge_arch++;
        ui.log(`ç ”å‘: æ¶æ„å‡çº§æˆåŠŸ`, "log-good"); ui.update();
    },

    unlockFeature: function(id) {
        let f = GAME_PARAMS.FEATURES[id];
        if (this.money < f.cost || this.resources.rd < f.rd) { ui.log("èµ„æºä¸è¶³", "log-bad"); return; }
        this.money -= f.cost; this.resources.rd -= f.rd;
        this.features_unlocked[id] = true;
        ui.log(`è§£é”: ${f.name}`, "log-good");
        ui.renderRD(); if(id==='school') ui.renderClasses(); ui.update();
    },

    runClass: function(id) {
        let conf = GAME_PARAMS.CLASSES[id], st = this.class_state[id];
        if (conf.season && !conf.season.includes(this.date.month)) { ui.log("å­£èŠ‚ä¸ç¬¦ (éœ€7-10æœˆ)", "log-bad"); return; }
        if (st.cooldown > 0) return;
        if (this.money < conf.req_money || this.resources.acad < conf.req_acad) { ui.log("æ— æ³•å¼€è¯¾ (èµ„æºä¸è¶³)", "log-bad"); return; }
        
        this.money -= conf.req_money; this.resources.acad -= conf.req_acad;
        this.money += conf.inc_base * st.level; st.cooldown = 3;
        ui.log(`ç½‘æ ¡: ${conf.name} å¼€è¯¾`, "log-good"); ui.update();
    },

    upgradeClass: function(id) {
        let conf = GAME_PARAMS.CLASSES[id], st = this.class_state[id];
        if (st.level >= conf.max) return;
        
        let cm = conf.cost_base * st.level;
        let ca = conf.acad_base * st.level;
        
        if (this.money < cm || this.resources.acad < ca) { ui.log("å‡çº§èµ„æºä¸è¶³", "log-bad"); return; }
        this.money -= cm; this.resources.acad -= ca; st.level++;
        ui.log(`ç½‘æ ¡: å‡çº§ ${conf.name}`, "log-good"); ui.renderClasses(); ui.update();
    },

    endGame: function() {
        let u = this.stats.users, p = this.stats.problems;
        let score = (u.core/3) + (u.active/10) + (u.normal/100) + (3*p.high + p.mid - p.low) + (0.01 * this.stats.total_solutions);
        score *= (this.stats.reputation + 1);
        alert(`æ¸¸æˆç»“æŸï¼æœ€ç»ˆå¾—åˆ†: ${score.toFixed(2)}`);
        document.getElementById('next-month-btn').disabled = true;
    }
};

const ui = {
    update: function() {
        document.getElementById('disp-date').innerText = `${game.date.year}-${String(game.date.month).padStart(2,'0')}`;
        document.getElementById('disp-money').innerText = game.money;
        document.getElementById('disp-rep').innerText = game.stats.reputation.toFixed(3);
        document.getElementById('rep-bar').style.width = Math.max(0, Math.min(100, (game.stats.reputation + 1)/2*100)) + '%';
        
        document.getElementById('disp-ap').innerText = game.ap;
        document.getElementById('disp-rd').innerText = Math.floor(game.resources.rd);
        document.getElementById('disp-acad').innerText = Math.floor(game.resources.acad);
        document.getElementById('disp-comm').innerText = Math.floor(game.resources.comm);
        
        let u = game.stats.users;
        document.getElementById('disp-users-total').innerText = u.normal + u.active + u.core;
        
        let failSpan = document.getElementById('disp-fail-months');
        failSpan.innerText = `${game.stats.consecutive_failure_months} / 6`;
        failSpan.style.color = game.stats.consecutive_failure_months > 0 ? '#ff5252' : '#aaa';

        document.getElementById('disp-last-subs').innerText = game.stats.last_month.subs.toLocaleString();
        document.getElementById('disp-last-sols').innerText = game.stats.last_month.sols.toLocaleString();

        let p = game.stats.problems;
        document.getElementById('disp-prob-high').innerText = p.high;
        document.getElementById('disp-prob-mid').innerText = p.mid;
        document.getElementById('disp-prob-low').innerText = p.low;
        
        let disk_cap = GAME_PARAMS.INITIAL.DISK_MB + (game.hardware.disk_extra_blocks * GAME_PARAMS.COSTS.DISK_BLOCK_SIZE_GB * 1024);
        document.getElementById('disp-disk').innerText = `${(game.hardware.disk_used/1024).toFixed(1)} / ${(disk_cap/1024).toFixed(1)} GB`;
        
        document.getElementById('disp-server-core').innerText = game.hardware.server_cores;
        document.getElementById('disp-server-arch').innerText = game.hardware.server_arch;
        document.getElementById('disp-judge-core').innerText = game.hardware.judge_cores;
        document.getElementById('disp-judge-arch').innerText = game.hardware.judge_arch;
        
        // Load Calculation
        let server_arch_bonus = (game.hardware.server_arch - 1) * 100;
        let server_cap_unit = 500 - (game.features_unlocked.team?50:0) - (game.features_unlocked.api?50:0) + server_arch_bonus;
        let s_cap = game.hardware.server_cores * server_cap_unit;
        let load = Math.floor(u.active + (u.normal/3) + (u.core*3));
        if ([7,8,9,10].includes(game.date.month)) load = Math.floor(load * 1.3);
        
        document.getElementById('disp-server-load').innerText = load;
        document.getElementById('disp-server-cap').innerText = s_cap;

        // Forecast
        let salary = 0;
        for (let k in game.staff) salary += game.staff[k] * GAME_PARAMS.HIRING[k].cost;
        
        let hw_cost = game.hardware.disk_extra_blocks * GAME_PARAMS.COSTS.DISK_BLOCK_RENT;
        let next_month = game.date.month + 1, next_year = game.date.year;
        if (next_month > 12) { next_month = 1; next_year++; }
        let will_charge_hw = (next_year > 2013) || (next_year === 2013 && next_month >= 7);
        if (will_charge_hw) {
            hw_cost += game.hardware.server_cores * GAME_PARAMS.COSTS.SERVER_CORE_RENT;
            hw_cost += game.hardware.judge_cores * GAME_PARAMS.COSTS.JUDGE_CORE_RENT;
        }
        let total_expense = salary + hw_cost;
        
        let api_income = 0;
        if (game.features_unlocked.api) api_income = Math.floor((u.normal+u.active+u.core) * 1.0); // Now 1.0
        let total_income = GAME_PARAMS.INCOME.MONTHLY_GRANT + api_income;
        
        let m_rd = 0, m_acad = 0, m_comm = 0;
        for (let k in GAME_PARAMS.FEATURES) if (game.features_unlocked[k]) m_rd += GAME_PARAMS.FEATURES[k].maintain;
        m_rd += 20 * (game.hardware.server_arch - 1) + 20 * (game.hardware.judge_arch - 1);
        let total_prob = p.high + p.mid + p.low;
        if (game.features_unlocked.difficulty) m_acad += total_prob * 0.05;
        if (game.features_unlocked.solution) m_acad += total_prob * 0.1;
        if (game.features_unlocked.discuss) m_comm += (u.normal+u.active+u.core) * 0.01;

        document.getElementById('fc-income').innerText = `+${total_income}`;
        document.getElementById('fc-salary').innerText = `-${salary}`;
        document.getElementById('fc-maint').innerText = `-${hw_cost}`;
        
        let net = total_income - total_expense;
        let netEl = document.getElementById('fc-net');
        netEl.innerText = (net >= 0 ? '+' : '') + net;
        netEl.style.color = (net >= 0 ? '#69f0ae' : '#ff5252');
        
        document.getElementById('fc-rd-cost').innerText = m_rd;
        document.getElementById('fc-acad-cost').innerText = Math.floor(m_acad);
        document.getElementById('fc-comm-cost').innerText = Math.floor(m_comm);

        let banner = document.getElementById('warning-banner');
        banner.style.display = (game.money + net < 0) ? 'block' : 'none';
        if (game.money + net < 0) banner.innerText = `âš ï¸ ä¸¥é‡è­¦å‘Šï¼šæŒ‰å½“å‰æ”¶æ”¯ï¼Œä¸‹ä¸ªæœˆå°†ç ´äº§ (é¢„è®¡ä½™é¢ ${game.money + net})ï¼`;

        let staff = game.staff, h = GAME_PARAMS.HIRING;
        document.getElementById('out-rd').innerText = staff.rd_student*h.rd_student.gain + staff.rd_uni*h.rd_uni.gain + staff.rd_full*h.rd_full.gain;
        document.getElementById('out-acad').innerText = staff.acad_part*h.acad_part.gain + staff.acad_full*h.acad_full.gain;
        document.getElementById('out-comm').innerText = staff.comm_part*h.comm_part.gain + staff.comm_full*h.comm_full.gain;
        
        ui.renderClasses(); // Refresh edu tab for cooldown/level text
    },
    
    log: function(msg, cls) {
        let div = document.createElement('div');
        div.className = 'log-entry ' + (cls||'');
        div.innerText = `[${game.date.year}-${game.date.month}] ` + msg;
        let area = document.getElementById('log-area');
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    },
    
    switchTab: function(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
    },

    renderRD: function() {
        let html = '';
        for (let k in GAME_PARAMS.FEATURES) {
            let f = GAME_PARAMS.FEATURES[k], isUn = game.features_unlocked[k];
            let btn = isUn ? `<button disabled>âœ… å·²å®Œæˆ</button>` : `<button onclick="game.unlockFeature('${k}')">ç ”å‘ ($${f.cost}, ç ”å‘ç‚¹ ${f.rd})</button>`;
            html += `<div style="background:#222; padding:10px; margin-bottom:8px; border-radius:4px; border-left: 3px solid ${isUn?'#4caf50':'#ff9800'}"><div style="display:flex; justify-content:space-between; align-items:center"><span style="font-weight:bold">${f.name}</span>${btn}</div><div style="font-size:0.8em; color:#888; margin-top:4px">${f.desc} (ç»´æŠ¤: ${f.maintain}/æœˆ)</div></div>`;
        }
        document.getElementById('rd-list').innerHTML = html;
    },
    
    renderClasses: function() {
        if (!game.features_unlocked.school) { document.getElementById('edu-list').innerHTML = `<div style="color:#888;text-align:center">è¯·å…ˆè§£é”ç½‘æ ¡åŠŸèƒ½</div>`; return; }
        let html = '';
        for(let k in GAME_PARAMS.CLASSES) {
            let c = GAME_PARAMS.CLASSES[k], st = game.class_state[k], isMax = st.level >= c.max;
            
            // Run Cost text
            let runCostText = `$${c.req_money} + ${c.req_acad} å­¦æœ¯`;
            // Upgrade Cost text
            let upCostText = isMax ? "MAX" : `$${c.cost_base*st.level} + ${c.acad_base*st.level} å­¦æœ¯`;
            
            let runBtn = (st.cooldown > 0) ? `<button class="btn-run" disabled>å†·å´ (${st.cooldown}æœˆ)</button>` : `<button class="btn-run" onclick="game.runClass('${k}')">å¼€è¯¾ (+${c.inc_base*st.level}å…ƒ)</button>`;
            let upBtn = isMax ? `<button class="btn-up" disabled>å·²æ»¡çº§</button>` : `<button class="btn-up" onclick="game.upgradeClass('${k}')">å‡çº§</button>`;
            
            html += `
            <div class="edu-card">
                <div class="edu-header">
                    <span>${c.name} <span style="color:#ffb74d">Lv.${st.level}</span></span>
                    <span style="font-size:0.8em; color:#888">Max: Lv.${c.max}</span>
                </div>
                <div class="edu-cost">
                    <div>å¼€è¯¾æˆæœ¬: ${runCostText}</div>
                    <div>å‡çº§æˆæœ¬: ${upCostText}</div>
                </div>
                <div class="edu-actions">
                    ${runBtn}
                    ${upBtn}
                </div>
            </div>`;
        }
        document.getElementById('edu-list').innerHTML = html;
    }
};

game.init();
</script>
</body>
</html>
